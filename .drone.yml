---
kind: pipeline
type: docker
name: build-windows-amd64

platform:
  os: linux
  arch: amd64

steps:
- name: build-and-package-windows
  image: rancher/dapper:v0.5.5
  environment:
    ENABLE_REGISTRY: 'true'
    GCLOUD_AUTH:
      from_secret: gcloud_auth
  commands:
#      - docker pull --quiet rancher/hardened-build-base:v1.16.4b7
    - docker pull --quiet alpine:latest
    - dapper -f Dockerfile.windows --target dapper make dapper-ci-windows
  volumes:
    - name: docker
      path: /var/run/docker.sock

#- name: test-windows
#  image: rancher/dapper:v0.5.5
#  secrets: [ gcloud_auth ]
#  environment:
#    ENABLE_REGISTRY: 'true'
#    GCLOUD_AUTH:
#      from_secret: gcloud_auth
#  commands:
#    - dapper -f Dockerfile.windows --target dapper make test
#  volumes:
#    - name: docker
#      path: /var/run/docker.sock

- name: publish-windows-dist-artifacts
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    checksum:
      - sha256
    checksum_file: CHECKSUMsum-amd64.txt
    checksum_flatten: true
    files:
      - dist/artifacts/*
    prerelease: true
  when:
    event:
      - tag
    instance:
      - drone-publish.rancher.io
    ref:
      - refs/head/windows
      - refs/tags/*

- name: publish-image-windows-runtime
  image: rancher/rke2-windows-runtime:v0.1
  commands:
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - DRONE_TAG=${DRONE_TAG} make publish-image-windows-runtime
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  volumes:
    - name: docker
      path: /var/run/docker.sock
  when:
    event:
      - tag
    instance:
      - drone-publish.rancher.io
    ref:
      - refs/head/windows
      - refs/tags/*

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock

---
kind: pipeline
type: docker
name: manifest-windows

platform:
  os: windows
  arch: amd64

steps:
  - name: manifest-windows-runtime
    image: rancher/windows-runtime-base:v0.1
    commands:
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - DRONE_TAG=${DRONE_TAG} make publish-manifest-windows-runtime
    environment:
      DOCKER_PASSWORD:
        from_secret: docker_password
      DOCKER_USERNAME:
        from_secret: docker_username
    volumes:
      - name: docker
        path: /var/run/docker.sock
    when:
      event:
        - tag
      instance:
        - drone-publish.rancher.io
      ref:
        - refs/head/windows
        - refs/tags/*

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock

depends_on:
  - build-windows-amd64

#---
#kind: pipeline
#type: docker
#name: dispatch-windows
#
#platform:
#  os: windows
#  arch: amd64
#
#steps:
#  - name: dispatch
#    image: rancher/dapper:v0.5.5
#    commands:
#      - dapper -f Dockerfile.windows --target dapper make dispatch
#    environment:
#      PAT_TOKEN:
#        from_secret: github_token
#      PAT_USERNAME:
#        from_secret: pat_username
#    volumes:
#      - name: docker
#        path: /var/run/docker.sock
#    when:
#      event:
#        - tag
#      instance:
#        - drone-publish.rancher.io
#      ref:
#        - refs/head/windows
#        - refs/tags/*
#
#volumes:
#  - name: docker
#    host:
#      path: /var/run/docker.sock
#
#depends_on:
#  - manifest-windows
#
#...
